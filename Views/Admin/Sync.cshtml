@{
    ViewData["Title"] = "HEI Sync Dashboard";
    var programsStatus = ViewBag.ProgramsStatus as UniversityFinder.Models.SyncStatus;
}

<div class="min-h-screen bg-gradient-to-br from-gray-50 to-gray-100 dark:from-gray-900 dark:to-gray-800 py-12">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Header -->
        <div class="mb-12">
            <h1 class="text-4xl md:text-5xl font-bold font-display mb-4 gradient-text">HEI API Synchronization</h1>
            <p class="text-xl text-gray-600 dark:text-gray-400">Manage university data synchronization</p>
        </div>
        
        <!-- Alert Messages -->
        @if (TempData["SuccessMessage"] != null)
        {
            <div class="mb-6 glass dark:glass-dark rounded-2xl p-4 border-l-4 border-green-500 bg-green-50/50 dark:bg-green-900/20">
                <div class="flex items-center gap-3">
                    <i data-lucide="check-circle" class="w-6 h-6 text-green-500"></i>
                    <p class="text-green-800 dark:text-green-200">@TempData["SuccessMessage"]</p>
                </div>
            </div>
        }
        @if (TempData["ErrorMessage"] != null)
        {
            <div class="mb-6 glass dark:glass-dark rounded-2xl p-4 border-l-4 border-red-500 bg-red-50/50 dark:bg-red-900/20">
                <div class="flex items-center gap-3">
                    <i data-lucide="alert-circle" class="w-6 h-6 text-red-500"></i>
                    <p class="text-red-800 dark:text-red-200">@TempData["ErrorMessage"]</p>
                </div>
            </div>
        }
        @if (TempData["InfoMessage"] != null)
        {
            <div class="mb-6 glass dark:glass-dark rounded-2xl p-4 border-l-4 border-blue-500 bg-blue-50/50 dark:bg-blue-900/20">
                <div class="flex items-center gap-3">
                    <i data-lucide="info" class="w-6 h-6 text-blue-500"></i>
                    <p class="text-blue-800 dark:text-blue-200">@TempData["InfoMessage"]</p>
                </div>
            </div>
        }
        
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Sync Universities from RVU Card -->
            <div class="lg:col-span-1">
                <div class="glass dark:glass-dark rounded-3xl p-8">
                    <div class="w-16 h-16 mb-6 rounded-2xl bg-gradient-to-br from-green-500 to-emerald-500 flex items-center justify-center">
                        <i data-lucide="building-2" class="w-8 h-8 text-white"></i>
                    </div>
                    <h2 class="text-2xl font-bold mb-3">Sync from RVU (NACID)</h2>
                    <p class="text-gray-600 dark:text-gray-400 mb-6">
                        Fetch and sync accredited Bulgarian universities from the official RVU (NACID) register. This is the primary data source for Bulgarian universities.
                    </p>
                    <form asp-action="SyncFromRvu" method="post">
                        @Html.AntiForgeryToken()
                        <button 
                            type="submit" 
                            class="w-full px-6 py-3 bg-gradient-to-r from-green-600 to-emerald-600 text-white rounded-xl font-semibold hover:shadow-lg transform hover:scale-105 transition-all flex items-center justify-center gap-2"
                        >
                            <i data-lucide="download" class="w-5 h-5"></i>
                            Sync Universities from RVU
                        </button>
                    </form>
                </div>
            </div>
            
            <!-- Legacy HEI Sync Card (Deprecated) -->
            <div class="lg:col-span-1">
                <div class="glass dark:glass-dark rounded-3xl p-8 opacity-60">
                    <div class="w-16 h-16 mb-6 rounded-2xl bg-gradient-to-br from-gray-400 to-gray-500 flex items-center justify-center">
                        <i data-lucide="building-2" class="w-8 h-8 text-white"></i>
                    </div>
                    <h2 class="text-2xl font-bold mb-3">Sync Universities (Legacy)</h2>
                    <p class="text-gray-600 dark:text-gray-400 mb-6">
                        <span class="text-red-500 font-semibold">DEPRECATED:</span> HEI API sync is no longer available. Please use RVU (NACID) data source instead.
                    </p>
                    <form asp-action="SyncUniversities" method="post">
                        @Html.AntiForgeryToken()
                        <button 
                            type="submit" 
                            class="w-full px-6 py-3 bg-gradient-to-r from-gray-400 to-gray-500 text-white rounded-xl font-semibold cursor-not-allowed opacity-50"
                            disabled
                        >
                            <i data-lucide="x-circle" class="w-5 h-5"></i>
                            Deprecated
                        </button>
                    </form>
                </div>
            </div>
            
            <!-- Sync Programs Card -->
            <div class="lg:col-span-2">
                <div class="glass dark:glass-dark rounded-3xl p-8">
                    <div class="flex items-center justify-between mb-6">
                        <div>
                            <h2 class="text-2xl font-bold mb-2">Sync Programs & Subjects</h2>
                            <p class="text-gray-600 dark:text-gray-400">
                                Fetch and sync programs and subjects for all universities
                            </p>
                        </div>
                        <div class="w-16 h-16 rounded-2xl bg-gradient-to-br from-blue-500 to-cyan-500 flex items-center justify-center">
                            <i data-lucide="book-open" class="w-8 h-8 text-white"></i>
                        </div>
                    </div>
                    
                    <!-- Status Dashboard -->
                    <div id="syncStatusCard" class="mb-6 glass dark:glass-dark rounded-2xl p-6">
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center gap-3">
                                <span class="text-lg font-semibold">Sync Status:</span>
                                <span id="statusBadge" class="px-4 py-1 rounded-full text-sm font-semibold bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300">
                                    Loading...
                                </span>
                            </div>
                        </div>
                        
                        <div id="statusMessage" class="text-gray-600 dark:text-gray-400 mb-4 text-sm">
                            Loading status...
                        </div>
                        
                        <!-- Progress Bar -->
                        <div id="statusProgress" class="mb-4" style="display: none;">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm font-medium">Progress</span>
                                <span id="progressText" class="text-sm font-bold">0%</span>
                            </div>
                            <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-3 overflow-hidden">
                                <div 
                                    id="progressBar" 
                                    class="h-full bg-gradient-to-r from-purple-600 to-pink-600 rounded-full transition-all duration-500 ease-out"
                                    style="width: 0%"
                                ></div>
                            </div>
                        </div>
                        
                        <!-- Stats Grid -->
                        <div id="statusDetails" class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                            <div>
                                <div class="text-gray-500 dark:text-gray-400 mb-1">Total</div>
                                <div id="totalItems" class="text-2xl font-bold gradient-text">-</div>
                            </div>
                            <div>
                                <div class="text-gray-500 dark:text-gray-400 mb-1">Processed</div>
                                <div id="processedItems" class="text-2xl font-bold gradient-text">-</div>
                            </div>
                            <div>
                                <div class="text-green-600 dark:text-green-400 mb-1">Success</div>
                                <div id="successCount" class="text-2xl font-bold text-green-600 dark:text-green-400">-</div>
                            </div>
                            <div>
                                <div class="text-red-600 dark:text-red-400 mb-1">Errors</div>
                                <div id="errorCount" class="text-2xl font-bold text-red-600 dark:text-red-400">-</div>
                            </div>
                        </div>
                        
                        <div class="mt-4 text-xs text-gray-500 dark:text-gray-400">
                            Last sync: <span id="syncTime">Never</span>
                        </div>
                    </div>
                    
                    <!-- Sync Button -->
                    <form asp-action="SyncPrograms" method="post">
                        @Html.AntiForgeryToken()
                        <button 
                            id="syncButton" 
                            type="submit" 
                            class="w-full px-6 py-4 bg-gradient-to-r from-blue-600 to-cyan-600 text-white rounded-xl font-semibold hover:shadow-lg transform hover:scale-105 transition-all flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none"
                            disabled
                        >
                            <span id="buttonText">Sync Programs from HEI API</span>
                            <span id="buttonSpinner" class="hidden">
                                <i data-lucide="loader-2" class="w-5 h-5 animate-spin"></i>
                            </span>
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let statusCheckInterval;
        
        function updateSyncStatus() {
            fetch('@Url.Action("GetSyncStatus", "Admin")?syncType=Programs')
                .then(response => response.json())
                .then(data => {
                    const statusBadge = document.getElementById('statusBadge');
                    const statusMessage = document.getElementById('statusMessage');
                    const syncButton = document.getElementById('syncButton');
                    const buttonText = document.getElementById('buttonText');
                    const buttonSpinner = document.getElementById('buttonSpinner');
                    const statusProgress = document.getElementById('statusProgress');
                    const progressBar = document.getElementById('progressBar');
                    const progressText = document.getElementById('progressText');
                    
                    // Update badge
                    if (data.isRunning) {
                        statusBadge.textContent = 'Running';
                        statusBadge.className = 'px-4 py-1 rounded-full text-sm font-semibold bg-blue-500 text-white animate-pulse';
                        syncButton.disabled = true;
                        buttonText.textContent = 'Sync in Progress...';
                        buttonSpinner.classList.remove('hidden');
                        statusProgress.style.display = 'block';
                    } else {
                        statusBadge.textContent = data.status;
                        if (data.status === 'Completed') {
                            statusBadge.className = 'px-4 py-1 rounded-full text-sm font-semibold bg-green-500 text-white';
                        } else if (data.status === 'Failed') {
                            statusBadge.className = 'px-4 py-1 rounded-full text-sm font-semibold bg-red-500 text-white';
                        } else {
                            statusBadge.className = 'px-4 py-1 rounded-full text-sm font-semibold bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300';
                        }
                        syncButton.disabled = false;
                        buttonText.textContent = 'Sync Programs from HEI API';
                        buttonSpinner.classList.add('hidden');
                        statusProgress.style.display = 'block';
                        
                        if (data.status === 'Completed' || data.status === 'Failed') {
                            progressBar.style.width = '100%';
                            progressText.textContent = '100%';
                        }
                    }
                    
                    // Update message
                    statusMessage.textContent = data.message || 'No message available';
                    
                    // Update progress
                    const progress = Math.min(100, data.progressPercent || 0);
                    progressBar.style.width = progress + '%';
                    progressText.textContent = progress + '%';
                    
                    // Update details
                    document.getElementById('totalItems').textContent = data.totalItems || 0;
                    document.getElementById('processedItems').textContent = data.processedItems || 0;
                    document.getElementById('successCount').textContent = data.successCount || 0;
                    document.getElementById('errorCount').textContent = data.errorCount || 0;
                    
                    // Update last sync time
                    if (data.lastSyncTime) {
                        const syncTime = new Date(data.lastSyncTime);
                        document.getElementById('syncTime').textContent = syncTime.toLocaleString();
                    } else {
                        document.getElementById('syncTime').textContent = 'Never';
                    }
                    
                    // Stop checking if not running
                    if (!data.isRunning && statusCheckInterval) {
                        clearInterval(statusCheckInterval);
                        statusCheckInterval = null;
                    }
                })
                .catch(error => {
                    console.error('Error fetching sync status:', error);
                });
        }
        
        // Initial status update
        updateSyncStatus();
        
        // Auto-refresh every 2 seconds if sync is running
        statusCheckInterval = setInterval(() => {
            updateSyncStatus();
        }, 2000);
        
        // Clean up interval on page unload
        window.addEventListener('beforeunload', () => {
            if (statusCheckInterval) {
                clearInterval(statusCheckInterval);
            }
        });
        
        lucide.createIcons();
        
        // Re-initialize icons periodically for spinner animation
        setInterval(() => {
            lucide.createIcons();
        }, 100);
    </script>
}
